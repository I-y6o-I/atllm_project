networks:
  app-network:
    driver: bridge

volumes:
  postgres-users-data:
  postgres-feedback-data:
  postgres-labs-data:
  postgres-articles-data:
  postgres-ml-data:
  postgres-marimo-data:
  ml-models:
  minio-data:
  mongodb-labs-data:
  mongodb-feedback-data:
  qdrant-data:

services:
  haproxy:
    image: haproxy:2.8
    volumes:
      - ./haproxy:/usr/local/etc/haproxy:ro
    environment:
      - ACTIVE_ENV=default
    ports:
      - "80:80"
      - "8404:8404"
    networks:
      - app-network
    restart: unless-stopped

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    ports:
      - "8090:8080"
    networks:
      - app-network
    restart: unless-stopped

  frontend:
    image: ghcr.io/iu-capstone-project-2025/open-labs-share-frontend:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
      args:
        - VITE_API_GATEWAY_URL=http://localhost
    environment:
      - NODE_ENV=production
      - VITE_API_GATEWAY_ENDPOINT=https://open-labs-share.online/api/v1
      - VITE_AUTH_API_ENDPOINT=https://open-labs-share.online/api/v1/auth
      - AUTH_SERVICE_HOST_NGINX=auth-service
      - API_GATEWAY_HOST_NGINX=api-gateway
    expose:
      - "80"
    networks:
      app-network:
        aliases:
          - frontend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s

  api-gateway:
    image: ghcr.io/iu-capstone-project-2025/open-labs-share-api-gateway:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/Dockerfile.api-gateway
    environment:
      - SPRING_APP_PORT=8080
      - AUTH_SERVICE_HOST=auth-service
      - AUTH_SERVICE_PORT=9092
      - USER_SERVICE_HOST=users-service
      - USER_SERVICE_PORT=9093
      - LAB_SERVICE_HOST=labs-service
      - LAB_SERVICE_PORT=9091
      - ARTICLE_SERVICE_HOST=articles-service
      - ARTICLE_SERVICE_PORT=50051
      - ML_SERVICE_HOST=ml-service
      - ML_SERVICE_PORT=8082
      - SPRING_PROFILES_ACTIVE=docker
      - FEEDBACK_SERVICE_HOST=feedback-service
      - FEEDBACK_SERVICE_PORT=9090
    expose:
      - "8080"
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s

  auth-service:
    image: ghcr.io/iu-capstone-project-2025/open-labs-share-auth-service:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/Dockerfile.auth-service
    environment:
      - PORT=8081
      - GRPC_PORT=9092
      - USERS_SERVICE_HOST=users-service
      - USERS_SERVICE_PORT=9093
      - JWT_SIGNING_KEY=${JWT_SIGNING_KEY:-adminadmin}
      - SPRING_PROFILES_ACTIVE=docker
    expose:
      - "8081"
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s

  users-service:
    image: ghcr.io/iu-capstone-project-2025/open-labs-share-users-service:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/Dockerfile.users-service
    environment:
      - GRPC_PORT=9093
      - DB_URL=jdbc:postgresql://postgres-users:5432/users_service
      - DB_USERNAME=users_user
      - DB_PASSWORD=${POSTGRES_USERS_PASSWORD:-postgres}
      - SPRING_PROFILES_ACTIVE=docker
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=127.0.0.1:9093"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s
    depends_on:
      - postgres-users

  # labs-service:
  #   image: ghcr.io/iu-capstone-project-2025/open-labs-share-labs-service:${IMAGE_TAG:-latest}
  #   build:
  #     context: .
  #     dockerfile: docker/Dockerfile.labs-service
  #   environment:
  #     - SERVICE_HOST=0.0.0.0
  #     - SERVICE_PORT=9091
  #     - POSTGRESQL_HOST=postgres-labs
  #     - POSTGRESQL_PORT=5432
  #     - POSTGRESQL_USER=labs_user
  #     - POSTGRESQL_PASSWORD=${POSTGRES_LABS_PASSWORD:-postgres}
  #     - POSTGRESQL_NAME=labs_db
  #     - MINIO_ENDPOINT=minio:9000
  #     - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
  #     - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
  #     - MONGODB_HOST=mongodb-labs
  #     - MONGODB_PORT=27017
  #     - MONGODB_USER=${MONGO_ROOT_USER:-mongo}
  #     - MONGODB_PASSWORD=${MONGO_ROOT_PASSWORD:-mongo}
  #     - MONGODB_NAME=labs_mongo_db
  #   networks:
  #     - app-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "grpc_health_probe", "-addr=127.0.0.1:9091"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 300s
  #   depends_on:
  #     - postgres-labs
  #     - mongodb-labs
  #     - minio

  articles-service:
    image: ghcr.io/iu-capstone-project-2025/open-labs-share-articles-service:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/Dockerfile.articles-service
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=50051
      - POSTGRES_HOST=postgres-articles
      - POSTGRES_PORT=5432
      - POSTGRES_USER=articles_user
      - POSTGRES_PASSWORD=${POSTGRES_ARTICLES_PASSWORD:-password}
      - POSTGRES_NAME=articles_db
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=127.0.0.1:50051"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s
    depends_on:
      - postgres-articles
      - minio

  # feedback-service:
  #   image: ghcr.io/iu-capstone-project-2025/open-labs-share-feedback-service:${IMAGE_TAG:-latest}
  #   build:
  #     context: .
  #     dockerfile: docker/Dockerfile.feedback-service
  #   environment:
  #     - GRPC_PORT=9090
  #     - POSTGRES_HOST=postgres-feedback
  #     - POSTGRES_PORT=5432
  #     - POSTGRES_USER=feedback_user
  #     - POSTGRES_PASSWORD=${POSTGRES_FEEDBACK_PASSWORD:-feedback_password}
  #     - POSTGRES_DB=feedback_db
  #     - MINIO_ENDPOINT=minio:9000
  #     - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
  #     - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
  #     - MINIO_BUCKET_NAME=feedback
  #     - MINIO_USE_SSL=false
  #     - MONGODB_URI=mongodb://${MONGO_ROOT_USER:-adminadmin}:${MONGO_ROOT_PASSWORD:-adminadmin}@mongodb-feedback:27017
  #     - MONGODB_DATABASE=feedback
  #     - MONGODB_COLLECTION=comments
  #   networks:
  #     - app-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "grpc_health_probe", "-addr=127.0.0.1:9090"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 300s
  #   depends_on:
  #     - postgres-feedback
  #     - mongodb-feedback
  #     - minio

  ml-service:
    image: ghcr.io/iu-capstone-project-2025/open-labs-share-ml-service:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/Dockerfile.ml-service
    environment:
      - SERVICE_PORT=8082
      - DEVICE=cpu
      - RAG_DB_PATH=/app/ml/faiss
      - SCORE_THRESHOLD=1.0
      - EMBEDDING_MODEL_NAME=BAAI/bge-small-en-v1.5
      - LLM_MODEL_NAME=Qwen/Qwen2.5-Coder-1.5B-Instruct
      - PDF_DIR=/app/ml/data/predator-pray-22/pdfs
      - CODE_DIR=/app/ml/data/predator-pray-22/code
      - POSTGRES_USER=ml_user
      - POSTGRES_PASSWORD=${POSTGRES_ML_PASSWORD:-password}
      - POSTGRES_HOST=postgres-ml
      - POSTGRES_PORT=5432
      - POSTGRES_DB=chat_history_db
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      - REDIS_BROKER_URL=${REDIS_BROKER_URL:-redis://ml-redis-broker:6379/0}
      - QDRANT_HOST=${QDRANT_HOST:-ml-qdrant}
      - QDRANT_PORT=${QDRANT_PORT:-6333}
    expose:
      - "8082"
    volumes:
      - ./ml:/app/ml
      - ml-models:/app/models
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s
    depends_on:
      postgres-ml:
        condition: service_healthy
      minio:
        condition: service_started
      ml-celery-worker:
        condition: service_started
      ml-qdrant:
        condition: service_started

  marimo-manager-service:
    build:
      context: .
      dockerfile: docker/Dockerfile.marimo-manager-service
    ports:
      - "8084:8084"
    environment:
      - SERVER_PORT=8084
      - DB_URL=jdbc:postgresql://postgres-marimo:5432/marimo_service
      - DB_USERNAME=${POSTGRES_MARIMO_USER:-marimo_user}
      - DB_PASSWORD=${POSTGRES_MARIMO_PASSWORD:-password}
      - PYTHON_SERVICE_HOST=marimo-executor-service
      - PYTHON_SERVICE_PORT=9095
      - AUTH_SERVICE_HOST=auth-service
      - AUTH_SERVICE_PORT=9092
      - USERS_SERVICE_HOST=users-service
      - USERS_SERVICE_PORT=9093
      - ARTICLES_SERVICE_HOST=articles-service
      - ARTICLES_SERVICE_PORT=50051
      - LABS_SERVICE_HOST=labs-service
      - LABS_SERVICE_PORT=9091
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_BUCKET=marimo
      - SPRING_PROFILES_ACTIVE=docker
    depends_on:
      - postgres-marimo
      - marimo-executor-service
    networks:
      - app-network
    restart: unless-stopped

  marimo-executor-service:
    build:
      context: .
      dockerfile: docker/Dockerfile.marimo-executor-service
    environment:
      - GRPC_PORT=9095
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_BUCKET=marimo
    networks:
      - app-network
    restart: unless-stopped

  postgres-ml:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=chat_history_db
      - POSTGRES_USER=ml_user
      - POSTGRES_PASSWORD=${POSTGRES_ML_PASSWORD:-password}
    volumes:
      - postgres-ml-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ml_user -d chat_history_db"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s

  ml-redis-broker:
    image: redis:7
    ports:
      - "6379:6379"
    restart: unless-stopped
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s

  ml-celery-worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.ml-celery-worker
    environment:
      - REDIS_BROKER_URL=${REDIS_BROKER_URL:-redis://ml-redis-broker:6379/0}
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - ./ml:/app/ml
    depends_on:
      - ml-redis-broker
      - minio
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "celery", "-A", "celery_broker.worker.celery_app", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s

  ml-qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - app-network
    restart: unless-stopped

  postgres-users:
    image: postgres:15
    environment:
      - POSTGRES_DB=users_service
      - POSTGRES_USER=users_user
      - POSTGRES_PASSWORD=${POSTGRES_USERS_PASSWORD:-postgres}
    volumes:
      - postgres-users-data:/var/lib/postgresql/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U users_user -d users_service"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s

  postgres-feedback:
    image: postgres:15
    environment:
      - POSTGRES_DB=feedback_db
      - POSTGRES_USER=feedback_user
      - POSTGRES_PASSWORD=${POSTGRES_FEEDBACK_PASSWORD:-feedback_password}
    volumes:
      - postgres-feedback-data:/var/lib/postgresql/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U feedback_user -d feedback_db"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s

  postgres-labs:
    image: postgres:15
    environment:
      - POSTGRES_DB=labs_db
      - POSTGRES_USER=labs_user
      - POSTGRES_PASSWORD=${POSTGRES_LABS_PASSWORD:-postgres}
    volumes:
      - postgres-labs-data:/var/lib/postgresql/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U labs_user -d labs_db"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s

  postgres-articles:
    image: postgres:15
    environment:
      - POSTGRES_DB=articles_db
      - POSTGRES_USER=articles_user
      - POSTGRES_PASSWORD=${POSTGRES_ARTICLES_PASSWORD:-password}
    volumes:
      - postgres-articles-data:/var/lib/postgresql/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U articles_user -d articles_db"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio-data:/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s

  mongodb-labs:
    image: mongo:latest
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER:-adminadmin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-adminadmin}
      - MONGO_INITDB_DATABASE=labs_mongo_db
    volumes:
      - mongodb-labs-data:/data/db
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: echo 'db.runCommand("ping").ok" | mongosh --quiet'
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s

  mongodb-feedback:
    image: mongo:latest
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER:-adminadmin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-adminadmin}
      - MONGO_INITDB_DATABASE=feedback
    volumes:
      - mongodb-feedback-data:/data/db
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: echo 'db.runCommand("ping").ok" | mongosh --quiet'
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s

  postgres-marimo:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=marimo_service
      - POSTGRES_USER=${POSTGRES_MARIMO_USER:-marimo_user}
      - POSTGRES_PASSWORD=${POSTGRES_MARIMO_PASSWORD:-password}
    volumes:
      - postgres-marimo-data:/var/lib/postgresql/data
    networks:
      - app-network
    restart: unless-stopped